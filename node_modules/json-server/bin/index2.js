var jsonServer = require('json-server')

// Returns an Express server
var server = jsonServer.create()

// Set default middlewares (logger, static, cors and no-cache)
server.use(jsonServer.defaults)

// Add custom routes
var multer = require('multer')
var upload = multer({ dest: 'uploads/' })

var mypath = "";

server.post('/upload', upload.single('image'), function(req, res) {
	mypath = "";
	mypath += req.file.path;
	res.redirect("/confirmation.html")
})

server.get('/extractSNP', function(req, res) {
	var awk = require('awk');
    var fs = require('fs');
    var intercept = require("intercept-stdout");
    var captured_text = "";
    var unhook_intercept = intercept(function(txt) {
    captured_text += txt;
    });
    awkscript = fs.readFileSync( __dirname + '/awkString.awk');
    data = fs.readFileSync(mypath);
    awk(awkscript, data);
    unhook_intercept();
    fs.writeFile('rsIDs.txt',captured_text,'utf8' ,function(){
        res.download('rsIDs.txt')});
})

// Returns an Express router
var router = jsonServer.router('JSONdbKeys.json')
server.use(router)

server.listen(3000)