//Javascript for single keyword search
$(document).ready(function() {
  //Database stats animation
  $('#stats').fadeOut("slow");
  $('#stats').fadeIn("slow");
  //Ajax loader animation
  $body = $("body");
  $(document).on({
    ajaxStart: function() {
      $body.addClass("loading");
    },
    ajaxStop: function() {
      $body.removeClass("loading");
    }
  });
  //Tooltop initialization
  $('[data-toggle="tooltip"]').tooltip();
  //Keypress triggers on click event
  $("#appendedInputButton").keypress(function(event) {
    if(event.keyCode == 13) {
      event.preventDefault();
      $("#singleButton").click();
    }
  });
  //Trigger search on click event
  $("#singleButton").on("click", function() {
    //Hide form
    $("#box").hide();
    //Get and check input value
    var input = $("#appendedInputButton").val();
    while (input.length == 0) {
      alert("You did not enter a keyword.");
      return;
    }
      //Choose applicable Ajax URL
      //var root = 'http://localhost:3000';
      var root = 'http://sniphunter.sanbi.ac.za';
      //Ajax call to database
      $.ajax({
      url: root
        + '/PMCOAI_rs_articles?keywords[]='
        + input,
      method: 'GET',
      }).then(function(data) {
        var listz = [];
        for (var i=0; i < data.length; i++) {
          //Create DOM element
          var elem = document.createElement("p");
          //Assign returned data to variables
          rsID = data[i].rs_number;

          cited = data[i].rs_number_cited_in_article;

          pub = data[i].pubmed_id;
          if (pub ==  "not available") {
            pub = "N/A";
          };

          year = data[i].publication_date;
          if (year ==  "not available") {
            year = "N/A";
          };

          doi = data[i].doi;
          if (doi ==  "not available") {
          doi = "N/A";
          };

          email = data[i].email_address;
          if (email == "not available") {
            email = "N/A";
          };

          title = data[i].article_title;
          if (title == "not available") {
            title = "<Please click for title>";
          };
          //Create textnodes with returned data
          var textnode1 = document.createTextNode("The term "
            + "\""
            + input
            + "\""
            + " is linked to an article entitled ");
          var titlenode = document.createTextNode(title);
          var textnode2 = document.createTextNode(" that also contains the SNP identifier "
            + rsID
            + ". This SNP identifier was mentioned at least "
            + cited
            + " time(s) in the article published in "
            + year
            + ". The article has also been tagged with Digital Object Identifier (DOI) "
            +  doi
            + " and with Pubmed Central ID "
            +  pub
            + ". For more information contact the correspondence author at ");
          var textnode3 = document.createTextNode(email);
          var textnode4 = document.createTextNode(" or");
          var textnode5 = document.createTextNode(" click here to view functional information.");

          elem.appendChild(textnode1);
          elem.title = "Read the full paper";
          elem.id = "updated";
          elem.style.background = "maroon";

          var emailer = document.createElement('a');
          emailer.style.color = "Royalblue";
          emailer.title = "Email correspondence author";
          emailer.href = "mailto:"
            + email
            + "?subject=Question about reference SNP "
            + rsID;
          emailer.target = "_top";
          emailer.appendChild(textnode3);

          var func = document.createElement('a');
          func.style.color = "Royalblue";
          func.title = "View functional information";
          func.href = "http://www.ncbi.nlm.nih.gov/snp/?term="
            + rsID;
          func.target = "_blank"
          func.appendChild(textnode5);

          var span = document.createElement('a');
          span.style.color = "Royalblue";
          span.title = "Read the full paper";
          span.style.fontStyle = "italic";
          span.href = "http://www.ncbi.nlm.nih.gov/pmc/?term="
            + pub;
          span.target = "_blank"
          span.appendChild(titlenode);
          elem.appendChild(span);
          elem.appendChild(textnode2);
          elem.appendChild(emailer);
          elem.appendChild(textnode4);
          elem.appendChild(func);
          //Push text objects to list and sort according to rs number occurrence
          listz.push([cited, elem]);
          listz.sort(function(a, b){return a[0]-b[0]});
        };
        //DOM update if no results found
        if (listz.length == 0) {
        var elem = document.createElement("h4");
        var noresults = document.createTextNode("\""
          + input
          + "\""
          + " did not match anything in the database");
        elem.appendChild(noresults);
        $("rs").append(elem);
        };
        //DOM update if results found
        while (listz.length != 0) {
          readyToGo = listz.pop();
          readyToGo = readyToGo.concat();
          $("rs").append(readyToGo[1]);
          $("[id=updated]").addClass("btn btn-default updateSpecs");
        };

      });

    });
  //Clear old results on click event and show form
  $("#clearButton").on("click", function() {
    $("#divz").children().empty();
    document.forms["myform1"].reset();
    $("#box").show();
    });

});


